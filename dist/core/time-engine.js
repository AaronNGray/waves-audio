"use strict";

var _classCallCheck = require("babel-runtime/helpers/class-call-check")["default"];

var _createClass = require("babel-runtime/helpers/create-class")["default"];

var defaultAudioContext = require("./audio-context");

/**
 * @class TimeEngine
 * @classdesc Base class for time engines
 *
 * Time engines are components that generate more or less regular audio events and/or playback a media stream.
 * They implement one or multiple interfaces to be synchronized by a master such as a scheduler, a transport or a play-control.
 * The provided interfaces are "scheduled", "transported", and "play-controlled".
 *
 * In the "scheduled" interface the engine implements a method "advanceTime" that is called by the master (usually the scheduler)
 * and returns the delay until the next call of "advanceTime". The master provides the engine with a function "resetNextTime"
 * to reschedule the next call to another time.
 *
 * In the "transported" interface the master (usually a transport) first calls the method "syncPosition" that returns the position
 * of the first event generated by the engine regarding the playing direction (sign of the speed argument). Events are generated
 * through the method "advancePosition" that returns the position of the next event generated through "advancePosition".
 *
 * In the "speed-controlled" interface the engine is controlled by the method "syncSpeed".
 *
 * For all interfaces the engine is provided with the attribute getters "currentTime" and "currentPosition" (for the case that the master
 * does not implement these attribute getters, the base class provides default implementations).
 */

var TimeEngine = (function () {

  /**
   * @constructor
   */

  function TimeEngine() {
    var audioContext = arguments[0] === undefined ? defaultAudioContext : arguments[0];

    _classCallCheck(this, TimeEngine);

    this.audioContext = audioContext;

    /**
     * Current master
     * @type {Object}
     */
    this.master = null;

    /**
     * Interface currently used
     * @type {String}
     */
    this["interface"] = null;

    /**
     * Output audio node
     * @type {Object}
     */
    this.outputNode = null;
  }

  _createClass(TimeEngine, {
    currentTime: {

      /**
       * Get the time engine's current master time
       * @type {Function}
       *
       * This function provided by the master.
       */

      get: function () {
        return this.audioContext.currentTime;
      }
    },
    currentPosition: {

      /**
       * Get the time engine's current master position
       * @type {Function}
       *
       * This function provided by the master.
       */

      get: function () {
        return 0;
      }
    },
    resetNextTime: {

      /**
       * Function provided by the scheduler to reset the engine's next time
       * @param {Number} time new engine time (immediately if not specified)
       */

      value: function resetNextTime() {
        var time = arguments[0] === undefined ? null : arguments[0];
      }
    },
    resetNextPosition: {

      /**
       * Function provided by the transport to reset the next position or to request resynchronizing the engine's position
       * @param {Number} position new engine position (will call syncPosition with the current position if not specified)
       */

      value: function resetNextPosition() {
        var position = arguments[0] === undefined ? null : arguments[0];
      }
    },
    __setGetters: {
      value: function __setGetters(getCurrentTime, getCurrentPosition) {
        if (getCurrentTime) {
          Object.defineProperty(this, "currentTime", {
            configurable: true,
            get: getCurrentTime
          });
        }

        if (getCurrentPosition) {
          Object.defineProperty(this, "currentPosition", {
            configurable: true,
            get: getCurrentPosition
          });
        }
      }
    },
    __deleteGetters: {
      value: function __deleteGetters() {
        delete this.currentTime;
        delete this.currentPosition;
      }
    },
    implementsScheduled: {

      /**
       * Check whether the time engine implements the scheduled interface
       **/

      value: function implementsScheduled() {
        return this.advanceTime && this.advanceTime instanceof Function;
      }
    },
    implementsTransported: {

      /**
       * Check whether the time engine implements the transported interface
       **/

      value: function implementsTransported() {
        return this.syncPosition && this.syncPosition instanceof Function && this.advancePosition && this.advancePosition instanceof Function;
      }
    },
    implementsSpeedControlled: {

      /**
       * Check whether the time engine implements the speed-controlled interface
       **/

      value: function implementsSpeedControlled() {
        return this.syncSpeed && this.syncSpeed instanceof Function;
      }
    },
    setScheduled: {
      value: function setScheduled(master, resetNextTime, getCurrentTime, getCurrentPosition) {
        this.master = master;
        this["interface"] = "scheduled";

        this.__setGetters(getCurrentTime, getCurrentPosition);

        if (resetNextTime) this.resetNextTime = resetNextTime;
      }
    },
    setTransported: {
      value: function setTransported(master, resetNextPosition, getCurrentTime, getCurrentPosition) {
        this.master = master;
        this["interface"] = "transported";

        this.__setGetters(getCurrentTime, getCurrentPosition);

        if (resetNextPosition) this.resetNextPosition = resetNextPosition;
      }
    },
    setSpeedControlled: {
      value: function setSpeedControlled(master, getCurrentTime, getCurrentPosition) {
        this.master = master;
        this["interface"] = "speed-controlled";

        this.__setGetters(getCurrentTime, getCurrentPosition);
      }
    },
    resetInterface: {
      value: function resetInterface() {
        this.__deleteGetters();

        delete this.resetNextTime;
        delete this.resetNextPosition;

        this.master = null;
        this["interface"] = null;
      }
    },
    connect: {

      /**
       * Connect audio node
       * @param {Object} target audio node
       */

      value: function connect(target) {
        this.outputNode.connect(target);
        return this;
      }
    },
    disconnect: {

      /**
       * Disconnect audio node
       * @param {Number} connection connection to be disconnected
       */

      value: function disconnect(connection) {
        this.outputNode.disconnect(connection);
        return this;
      }
    }
  });

  return TimeEngine;
})();

module.exports = TimeEngine;
/* written in ECMAscript 6 */
/**
 * @fileoverview WAVE audio time engine base class
 * @author Norbert.Schnell@ircam.fr, Victor.Saiz@ircam.fr, Karim.Barkati@ircam.fr
 */
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVzNi91dGlscy9wcmlvcml0eS1xdWV1ZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFPQSxJQUFJLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7SUF1Qi9DLFVBQVU7Ozs7OztBQUtILFdBTFAsVUFBVSxHQUtrQztRQUFwQyxZQUFZLGdDQUFHLG1CQUFtQjs7MEJBTDFDLFVBQVU7O0FBTVosUUFBSSxDQUFDLFlBQVksR0FBRyxZQUFZLENBQUM7Ozs7OztBQU1qQyxRQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQzs7Ozs7O0FBTW5CLFFBQUksYUFBVSxHQUFHLElBQUksQ0FBQzs7Ozs7O0FBTXRCLFFBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO0dBQ3hCOztlQXpCRyxVQUFVO0FBaUNWLGVBQVc7Ozs7Ozs7OztXQUFBLFlBQUc7QUFDaEIsZUFBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQztPQUN0Qzs7QUFRRyxtQkFBZTs7Ozs7Ozs7O1dBQUEsWUFBRztBQUNwQixlQUFPLENBQUMsQ0FBQztPQUNWOztBQU1ELGlCQUFhOzs7Ozs7O2FBQUEseUJBQWM7WUFBYixJQUFJLGdDQUFHLElBQUk7T0FBSTs7QUFNN0IscUJBQWlCOzs7Ozs7O2FBQUEsNkJBQWtCO1lBQWpCLFFBQVEsZ0NBQUcsSUFBSTtPQUFJOztBQUVyQyxnQkFBWTthQUFBLHNCQUFDLGNBQWMsRUFBRSxrQkFBa0IsRUFBRTtBQUMvQyxZQUFJLGNBQWMsRUFBRTtBQUNsQixnQkFBTSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsYUFBYSxFQUFFO0FBQ3pDLHdCQUFZLEVBQUUsSUFBSTtBQUNsQixlQUFHLEVBQUUsY0FBYztXQUNwQixDQUFDLENBQUM7U0FDSjs7QUFFRCxZQUFJLGtCQUFrQixFQUFFO0FBQ3RCLGdCQUFNLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxpQkFBaUIsRUFBRTtBQUM3Qyx3QkFBWSxFQUFFLElBQUk7QUFDbEIsZUFBRyxFQUFFLGtCQUFrQjtXQUN4QixDQUFDLENBQUM7U0FDSjtPQUNGOztBQUVELG1CQUFlO2FBQUEsMkJBQUc7QUFDaEIsZUFBTyxJQUFJLENBQUMsV0FBVyxDQUFDO0FBQ3hCLGVBQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQztPQUM3Qjs7QUFLRCx1QkFBbUI7Ozs7OzthQUFBLCtCQUFHO0FBQ3BCLGVBQVEsSUFBSSxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUMsV0FBVyxZQUFZLFFBQVEsQ0FBRTtPQUNuRTs7QUFLRCx5QkFBcUI7Ozs7OzthQUFBLGlDQUFHO0FBQ3RCLGVBQ0UsSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsWUFBWSxZQUFZLFFBQVEsSUFDMUQsSUFBSSxDQUFDLGVBQWUsSUFBSSxJQUFJLENBQUMsZUFBZSxZQUFZLFFBQVEsQ0FDaEU7T0FDSDs7QUFLRCw2QkFBeUI7Ozs7OzthQUFBLHFDQUFHO0FBQzFCLGVBQVEsSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsU0FBUyxZQUFZLFFBQVEsQ0FBRTtPQUMvRDs7QUFFRCxnQkFBWTthQUFBLHNCQUFDLE1BQU0sRUFBRSxhQUFhLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFO0FBQ3RFLFlBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO0FBQ3JCLFlBQUksYUFBVSxHQUFHLFdBQVcsQ0FBQzs7QUFFN0IsWUFBSSxDQUFDLFlBQVksQ0FBQyxjQUFjLEVBQUUsa0JBQWtCLENBQUMsQ0FBQzs7QUFFdEQsWUFBSSxhQUFhLEVBQ2YsSUFBSSxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUM7T0FDdEM7O0FBRUQsa0JBQWM7YUFBQSx3QkFBQyxNQUFNLEVBQUUsaUJBQWlCLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFO0FBQzVFLFlBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO0FBQ3JCLFlBQUksYUFBVSxHQUFHLGFBQWEsQ0FBQzs7QUFFL0IsWUFBSSxDQUFDLFlBQVksQ0FBQyxjQUFjLEVBQUUsa0JBQWtCLENBQUMsQ0FBQzs7QUFFdEQsWUFBSSxpQkFBaUIsRUFDbkIsSUFBSSxDQUFDLGlCQUFpQixHQUFHLGlCQUFpQixDQUFDO09BQzlDOztBQUVELHNCQUFrQjthQUFBLDRCQUFDLE1BQU0sRUFBRSxjQUFjLEVBQUUsa0JBQWtCLEVBQUU7QUFDN0QsWUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7QUFDckIsWUFBSSxhQUFVLEdBQUcsa0JBQWtCLENBQUM7O0FBRXBDLFlBQUksQ0FBQyxZQUFZLENBQUMsY0FBYyxFQUFFLGtCQUFrQixDQUFDLENBQUM7T0FDdkQ7O0FBRUQsa0JBQWM7YUFBQSwwQkFBRztBQUNmLFlBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQzs7QUFFdkIsZUFBTyxJQUFJLENBQUMsYUFBYSxDQUFDO0FBQzFCLGVBQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDOztBQUU5QixZQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztBQUNuQixZQUFJLGFBQVUsR0FBRyxJQUFJLENBQUM7T0FDdkI7O0FBTUQsV0FBTzs7Ozs7OzthQUFBLGlCQUFDLE1BQU0sRUFBRTtBQUNkLFlBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ2hDLGVBQU8sSUFBSSxDQUFDO09BQ2I7O0FBTUQsY0FBVTs7Ozs7OzthQUFBLG9CQUFDLFVBQVUsRUFBRTtBQUNyQixZQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUN2QyxlQUFPLElBQUksQ0FBQztPQUNiOzs7O1NBN0pHLFVBQVU7OztBQWdLaEIsTUFBTSxDQUFDLE9BQU8sR0FBRyxVQUFVLENBQUMiLCJmaWxlIjoiZXM2L3V0aWxzL3ByaW9yaXR5LXF1ZXVlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogd3JpdHRlbiBpbiBFQ01Bc2NyaXB0IDYgKi9cbi8qKlxuICogQGZpbGVvdmVydmlldyBXQVZFIGF1ZGlvIHRpbWUgZW5naW5lIGJhc2UgY2xhc3NcbiAqIEBhdXRob3IgTm9yYmVydC5TY2huZWxsQGlyY2FtLmZyLCBWaWN0b3IuU2FpekBpcmNhbS5mciwgS2FyaW0uQmFya2F0aUBpcmNhbS5mclxuICovXG5cInVzZSBzdHJpY3RcIjtcblxudmFyIGRlZmF1bHRBdWRpb0NvbnRleHQgPSByZXF1aXJlKFwiLi9hdWRpby1jb250ZXh0XCIpO1xuXG4vKipcbiAqIEBjbGFzcyBUaW1lRW5naW5lXG4gKiBAY2xhc3NkZXNjIEJhc2UgY2xhc3MgZm9yIHRpbWUgZW5naW5lc1xuICpcbiAqIFRpbWUgZW5naW5lcyBhcmUgY29tcG9uZW50cyB0aGF0IGdlbmVyYXRlIG1vcmUgb3IgbGVzcyByZWd1bGFyIGF1ZGlvIGV2ZW50cyBhbmQvb3IgcGxheWJhY2sgYSBtZWRpYSBzdHJlYW0uXG4gKiBUaGV5IGltcGxlbWVudCBvbmUgb3IgbXVsdGlwbGUgaW50ZXJmYWNlcyB0byBiZSBzeW5jaHJvbml6ZWQgYnkgYSBtYXN0ZXIgc3VjaCBhcyBhIHNjaGVkdWxlciwgYSB0cmFuc3BvcnQgb3IgYSBwbGF5LWNvbnRyb2wuXG4gKiBUaGUgcHJvdmlkZWQgaW50ZXJmYWNlcyBhcmUgXCJzY2hlZHVsZWRcIiwgXCJ0cmFuc3BvcnRlZFwiLCBhbmQgXCJwbGF5LWNvbnRyb2xsZWRcIi5cbiAqXG4gKiBJbiB0aGUgXCJzY2hlZHVsZWRcIiBpbnRlcmZhY2UgdGhlIGVuZ2luZSBpbXBsZW1lbnRzIGEgbWV0aG9kIFwiYWR2YW5jZVRpbWVcIiB0aGF0IGlzIGNhbGxlZCBieSB0aGUgbWFzdGVyICh1c3VhbGx5IHRoZSBzY2hlZHVsZXIpXG4gKiBhbmQgcmV0dXJucyB0aGUgZGVsYXkgdW50aWwgdGhlIG5leHQgY2FsbCBvZiBcImFkdmFuY2VUaW1lXCIuIFRoZSBtYXN0ZXIgcHJvdmlkZXMgdGhlIGVuZ2luZSB3aXRoIGEgZnVuY3Rpb24gXCJyZXNldE5leHRUaW1lXCJcbiAqIHRvIHJlc2NoZWR1bGUgdGhlIG5leHQgY2FsbCB0byBhbm90aGVyIHRpbWUuXG4gKlxuICogSW4gdGhlIFwidHJhbnNwb3J0ZWRcIiBpbnRlcmZhY2UgdGhlIG1hc3RlciAodXN1YWxseSBhIHRyYW5zcG9ydCkgZmlyc3QgY2FsbHMgdGhlIG1ldGhvZCBcInN5bmNQb3NpdGlvblwiIHRoYXQgcmV0dXJucyB0aGUgcG9zaXRpb25cbiAqIG9mIHRoZSBmaXJzdCBldmVudCBnZW5lcmF0ZWQgYnkgdGhlIGVuZ2luZSByZWdhcmRpbmcgdGhlIHBsYXlpbmcgZGlyZWN0aW9uIChzaWduIG9mIHRoZSBzcGVlZCBhcmd1bWVudCkuIEV2ZW50cyBhcmUgZ2VuZXJhdGVkXG4gKiB0aHJvdWdoIHRoZSBtZXRob2QgXCJhZHZhbmNlUG9zaXRpb25cIiB0aGF0IHJldHVybnMgdGhlIHBvc2l0aW9uIG9mIHRoZSBuZXh0IGV2ZW50IGdlbmVyYXRlZCB0aHJvdWdoIFwiYWR2YW5jZVBvc2l0aW9uXCIuXG4gKlxuICogSW4gdGhlIFwic3BlZWQtY29udHJvbGxlZFwiIGludGVyZmFjZSB0aGUgZW5naW5lIGlzIGNvbnRyb2xsZWQgYnkgdGhlIG1ldGhvZCBcInN5bmNTcGVlZFwiLlxuICpcbiAqIEZvciBhbGwgaW50ZXJmYWNlcyB0aGUgZW5naW5lIGlzIHByb3ZpZGVkIHdpdGggdGhlIGF0dHJpYnV0ZSBnZXR0ZXJzIFwiY3VycmVudFRpbWVcIiBhbmQgXCJjdXJyZW50UG9zaXRpb25cIiAoZm9yIHRoZSBjYXNlIHRoYXQgdGhlIG1hc3RlclxuICogZG9lcyBub3QgaW1wbGVtZW50IHRoZXNlIGF0dHJpYnV0ZSBnZXR0ZXJzLCB0aGUgYmFzZSBjbGFzcyBwcm92aWRlcyBkZWZhdWx0IGltcGxlbWVudGF0aW9ucykuXG4gKi9cbmNsYXNzIFRpbWVFbmdpbmUge1xuXG4gIC8qKlxuICAgKiBAY29uc3RydWN0b3JcbiAgICovXG4gIGNvbnN0cnVjdG9yKGF1ZGlvQ29udGV4dCA9IGRlZmF1bHRBdWRpb0NvbnRleHQpIHtcbiAgICB0aGlzLmF1ZGlvQ29udGV4dCA9IGF1ZGlvQ29udGV4dDtcblxuICAgIC8qKlxuICAgICAqIEN1cnJlbnQgbWFzdGVyXG4gICAgICogQHR5cGUge09iamVjdH1cbiAgICAgKi9cbiAgICB0aGlzLm1hc3RlciA9IG51bGw7XG5cbiAgICAvKipcbiAgICAgKiBJbnRlcmZhY2UgY3VycmVudGx5IHVzZWRcbiAgICAgKiBAdHlwZSB7U3RyaW5nfVxuICAgICAqL1xuICAgIHRoaXMuaW50ZXJmYWNlID0gbnVsbDtcblxuICAgIC8qKlxuICAgICAqIE91dHB1dCBhdWRpbyBub2RlXG4gICAgICogQHR5cGUge09iamVjdH1cbiAgICAgKi9cbiAgICB0aGlzLm91dHB1dE5vZGUgPSBudWxsO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgdGltZSBlbmdpbmUncyBjdXJyZW50IG1hc3RlciB0aW1lXG4gICAqIEB0eXBlIHtGdW5jdGlvbn1cbiAgICpcbiAgICogVGhpcyBmdW5jdGlvbiBwcm92aWRlZCBieSB0aGUgbWFzdGVyLlxuICAgKi9cbiAgZ2V0IGN1cnJlbnRUaW1lKCkge1xuICAgIHJldHVybiB0aGlzLmF1ZGlvQ29udGV4dC5jdXJyZW50VGltZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIHRpbWUgZW5naW5lJ3MgY3VycmVudCBtYXN0ZXIgcG9zaXRpb25cbiAgICogQHR5cGUge0Z1bmN0aW9ufVxuICAgKlxuICAgKiBUaGlzIGZ1bmN0aW9uIHByb3ZpZGVkIGJ5IHRoZSBtYXN0ZXIuXG4gICAqL1xuICBnZXQgY3VycmVudFBvc2l0aW9uKCkge1xuICAgIHJldHVybiAwO1xuICB9XG5cbiAgLyoqXG4gICAqIEZ1bmN0aW9uIHByb3ZpZGVkIGJ5IHRoZSBzY2hlZHVsZXIgdG8gcmVzZXQgdGhlIGVuZ2luZSdzIG5leHQgdGltZVxuICAgKiBAcGFyYW0ge051bWJlcn0gdGltZSBuZXcgZW5naW5lIHRpbWUgKGltbWVkaWF0ZWx5IGlmIG5vdCBzcGVjaWZpZWQpXG4gICAqL1xuICByZXNldE5leHRUaW1lKHRpbWUgPSBudWxsKSB7fVxuXG4gIC8qKlxuICAgKiBGdW5jdGlvbiBwcm92aWRlZCBieSB0aGUgdHJhbnNwb3J0IHRvIHJlc2V0IHRoZSBuZXh0IHBvc2l0aW9uIG9yIHRvIHJlcXVlc3QgcmVzeW5jaHJvbml6aW5nIHRoZSBlbmdpbmUncyBwb3NpdGlvblxuICAgKiBAcGFyYW0ge051bWJlcn0gcG9zaXRpb24gbmV3IGVuZ2luZSBwb3NpdGlvbiAod2lsbCBjYWxsIHN5bmNQb3NpdGlvbiB3aXRoIHRoZSBjdXJyZW50IHBvc2l0aW9uIGlmIG5vdCBzcGVjaWZpZWQpXG4gICAqL1xuICByZXNldE5leHRQb3NpdGlvbihwb3NpdGlvbiA9IG51bGwpIHt9XG5cbiAgX19zZXRHZXR0ZXJzKGdldEN1cnJlbnRUaW1lLCBnZXRDdXJyZW50UG9zaXRpb24pIHtcbiAgICBpZiAoZ2V0Q3VycmVudFRpbWUpIHtcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnY3VycmVudFRpbWUnLCB7XG4gICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgZ2V0OiBnZXRDdXJyZW50VGltZVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKGdldEN1cnJlbnRQb3NpdGlvbikge1xuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICdjdXJyZW50UG9zaXRpb24nLCB7XG4gICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgZ2V0OiBnZXRDdXJyZW50UG9zaXRpb25cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIF9fZGVsZXRlR2V0dGVycygpIHtcbiAgICBkZWxldGUgdGhpcy5jdXJyZW50VGltZTtcbiAgICBkZWxldGUgdGhpcy5jdXJyZW50UG9zaXRpb247XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgd2hldGhlciB0aGUgdGltZSBlbmdpbmUgaW1wbGVtZW50cyB0aGUgc2NoZWR1bGVkIGludGVyZmFjZVxuICAgKiovXG4gIGltcGxlbWVudHNTY2hlZHVsZWQoKSB7XG4gICAgcmV0dXJuICh0aGlzLmFkdmFuY2VUaW1lICYmIHRoaXMuYWR2YW5jZVRpbWUgaW5zdGFuY2VvZiBGdW5jdGlvbik7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgd2hldGhlciB0aGUgdGltZSBlbmdpbmUgaW1wbGVtZW50cyB0aGUgdHJhbnNwb3J0ZWQgaW50ZXJmYWNlXG4gICAqKi9cbiAgaW1wbGVtZW50c1RyYW5zcG9ydGVkKCkge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLnN5bmNQb3NpdGlvbiAmJiB0aGlzLnN5bmNQb3NpdGlvbiBpbnN0YW5jZW9mIEZ1bmN0aW9uICYmXG4gICAgICB0aGlzLmFkdmFuY2VQb3NpdGlvbiAmJiB0aGlzLmFkdmFuY2VQb3NpdGlvbiBpbnN0YW5jZW9mIEZ1bmN0aW9uXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayB3aGV0aGVyIHRoZSB0aW1lIGVuZ2luZSBpbXBsZW1lbnRzIHRoZSBzcGVlZC1jb250cm9sbGVkIGludGVyZmFjZVxuICAgKiovXG4gIGltcGxlbWVudHNTcGVlZENvbnRyb2xsZWQoKSB7XG4gICAgcmV0dXJuICh0aGlzLnN5bmNTcGVlZCAmJiB0aGlzLnN5bmNTcGVlZCBpbnN0YW5jZW9mIEZ1bmN0aW9uKTtcbiAgfVxuXG4gIHNldFNjaGVkdWxlZChtYXN0ZXIsIHJlc2V0TmV4dFRpbWUsIGdldEN1cnJlbnRUaW1lLCBnZXRDdXJyZW50UG9zaXRpb24pIHtcbiAgICB0aGlzLm1hc3RlciA9IG1hc3RlcjtcbiAgICB0aGlzLmludGVyZmFjZSA9IFwic2NoZWR1bGVkXCI7XG5cbiAgICB0aGlzLl9fc2V0R2V0dGVycyhnZXRDdXJyZW50VGltZSwgZ2V0Q3VycmVudFBvc2l0aW9uKTtcblxuICAgIGlmIChyZXNldE5leHRUaW1lKVxuICAgICAgdGhpcy5yZXNldE5leHRUaW1lID0gcmVzZXROZXh0VGltZTtcbiAgfVxuXG4gIHNldFRyYW5zcG9ydGVkKG1hc3RlciwgcmVzZXROZXh0UG9zaXRpb24sIGdldEN1cnJlbnRUaW1lLCBnZXRDdXJyZW50UG9zaXRpb24pIHtcbiAgICB0aGlzLm1hc3RlciA9IG1hc3RlcjtcbiAgICB0aGlzLmludGVyZmFjZSA9IFwidHJhbnNwb3J0ZWRcIjtcblxuICAgIHRoaXMuX19zZXRHZXR0ZXJzKGdldEN1cnJlbnRUaW1lLCBnZXRDdXJyZW50UG9zaXRpb24pO1xuXG4gICAgaWYgKHJlc2V0TmV4dFBvc2l0aW9uKVxuICAgICAgdGhpcy5yZXNldE5leHRQb3NpdGlvbiA9IHJlc2V0TmV4dFBvc2l0aW9uO1xuICB9XG5cbiAgc2V0U3BlZWRDb250cm9sbGVkKG1hc3RlciwgZ2V0Q3VycmVudFRpbWUsIGdldEN1cnJlbnRQb3NpdGlvbikge1xuICAgIHRoaXMubWFzdGVyID0gbWFzdGVyO1xuICAgIHRoaXMuaW50ZXJmYWNlID0gXCJzcGVlZC1jb250cm9sbGVkXCI7XG5cbiAgICB0aGlzLl9fc2V0R2V0dGVycyhnZXRDdXJyZW50VGltZSwgZ2V0Q3VycmVudFBvc2l0aW9uKTtcbiAgfVxuXG4gIHJlc2V0SW50ZXJmYWNlKCkge1xuICAgIHRoaXMuX19kZWxldGVHZXR0ZXJzKCk7XG5cbiAgICBkZWxldGUgdGhpcy5yZXNldE5leHRUaW1lO1xuICAgIGRlbGV0ZSB0aGlzLnJlc2V0TmV4dFBvc2l0aW9uO1xuXG4gICAgdGhpcy5tYXN0ZXIgPSBudWxsO1xuICAgIHRoaXMuaW50ZXJmYWNlID0gbnVsbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb25uZWN0IGF1ZGlvIG5vZGVcbiAgICogQHBhcmFtIHtPYmplY3R9IHRhcmdldCBhdWRpbyBub2RlXG4gICAqL1xuICBjb25uZWN0KHRhcmdldCkge1xuICAgIHRoaXMub3V0cHV0Tm9kZS5jb25uZWN0KHRhcmdldCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvKipcbiAgICogRGlzY29ubmVjdCBhdWRpbyBub2RlXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBjb25uZWN0aW9uIGNvbm5lY3Rpb24gdG8gYmUgZGlzY29ubmVjdGVkXG4gICAqL1xuICBkaXNjb25uZWN0KGNvbm5lY3Rpb24pIHtcbiAgICB0aGlzLm91dHB1dE5vZGUuZGlzY29ubmVjdChjb25uZWN0aW9uKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFRpbWVFbmdpbmU7XG4iXX0=